"""\
Precalculate a set of origins to use for training transformation prediction
models.

Usage:
    ap_choose_origins init <pisces_path> [-o <path>] [-f] [-n <neighbors>]
        [-r <radius>]
    ap_choose_origins calc <output_dir> [<num_workers> <worker_id>]
    ap_choose_origins finish <output_dir> [-d]

Arguments:
    <pisces_path>
        A path to a file specifying a subset of the PDB, as generated by the 
        PISCES web server.

    <output_dir>
        The path to the directory created by `ap_choose_origins init`, which 
        contains the input parameters and any output data frames.

Options:
    -o --output-path <path>     [default: origins_max_identity_{max_percent_identity}_max_resolution_{max_resolution_A}_min_neighbors_{min_neighbors}_radius_{radius_A}]

    -f --force
        If the output path already exists, overwrite it.  Otherwise, the 
        program will abort.
        
    -n --min-neighbors <int>    [default: 10]
        How many atoms must be in the vicinity of an atom (defined by the 
        radius below) in order for that atom to be considered as an origin.  
        The default is calculated by counting the number of atoms necessary to 
        fill half the space in question, assuming that each atom has a radius 
        of 0.7 Å.  Note that the most dense sphere packing fills 3/4 of the 
        available space, and that the empirical radii of C, N, and O are 
        between 0.6 and 0.7Å.  For the default radius of 3Å, this works out to 
        40 atoms.

        https://en.wikipedia.org/wiki/Sphere_packing
        https://en.wikipedia.org/wiki/Atomic_radii_of_the_elements

    -r --radius <angstroms>     [default: 5]
        The area in which to count neighboring atoms, in units of Angstroms.  
        See above for more detail.

    -d --dry-run
        Show status information, but don't actually write the consolidated 
        files or delete the unconsolidated ones.

Environment variables:
    PDB_DIR
        The path to the location of the actual PDB files...
"""

import docopt
from .neighbor_count import (
        OriginParams, choose_origins_for_tags, save_origins,
        save_origin_params, load_origin_params, consolidate_origins,
)
from ..atoms import load_pisces, parse_pisces_path
from pathlib import Path
from more_itertools import nth, chunked
from dataclasses import asdict
from functools import partial
from math import ceil
from tqdm import tqdm

def main():
    args = docopt.docopt(__doc__)

    if args['init']:
        pisces_path = Path(args['<pisces_path>'])
        pisces_df = load_pisces(pisces_path)
        origin_params = OriginParams(
                radius_A=float(args['--radius']),
                min_neighbors=int(args['--min-neighbors']),
        )
        path_params = {
                **parse_pisces_path(pisces_path),
                **asdict(origin_params),
        }
        output_path = Path(args['--output-path'].format(**path_params))

        try:
            save_origin_params(
                    output_path,
                    tags=pisces_df['tag'],
                    origin_params=origin_params, 
                    force=args['--force'],
            )
        except FileExistsError:
            print(f"Output path already exists: {output_path}")
            print("Aborting!  Use `-f` to overwrite.")
            raise SystemExit

    if args['calc']:
        output_path = Path(args['<output_dir>'])
        num_workers = int(args['<num_workers>'] or 1)
        worker_id = int(args['<worker_id>'] or 0)

        if worker_id >= num_workers:
            print(f"Worker id ({worker_id}) must be less than number of workers ({num_workers})")

        tags, origin_params = load_origin_params(output_path)
        num_tags_per_worker = int(ceil(len(tags) / num_workers))
        chunk = nth(chunked(tags, num_tags_per_worker), worker_id)

        origins, status = choose_origins_for_tags(tqdm(chunk), origin_params)
        save_origins(output_path, origins, status, (worker_id, num_workers))

    if args['finish']:
        output_path = Path(args['<output_dir>'])
        _, status = consolidate_origins(output_path, dry_run=args['--dry-run'])

        print(f"Loaded {len(status['tags_loaded'])} structures.")
        print(f"Skipped {len(status['tags_skipped'])} structures.")

        tags, _ = load_origin_params(output_path)
        tags_missing = set(tags) - set(status['tags_loaded'] + status['tags_skipped'])

        print(f"Missing {len(tags_missing)} structures.")


